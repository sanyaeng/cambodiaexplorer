<div id="business_left">
	<div id="businesslisting">
		<div id="userbusiness"></div>
	</div>
</div>



<link rel="stylesheet" href="css/businesslisting.css"/>
<script type="text/javascript">
	var locationList = new Array();
	function placeAllMarkers() {
		gmap.placeAllMarkers(locationList);
	}
	function arrangeBusinessListing(jBusinessList) {
		$.map(jBusinessList, function(jBusiness, i){
			var category = jBusiness.category;
			$("<div class='listing_parent context-menu' data-id='"+ jBusiness.businessId +"' id='item"+jBusiness.businessId+"'>").append($("<div class='businessview'>").append("<div class='name'><span>"+parseInt(i+1)+". </span>"+jBusiness.businessName+"</div>")
											 							.append("<div class='category'>"+category.catDesc+"</div>")
											 							.append("<div class='address'>" + jBusiness.businessAddress+"</div>"))
											 .appendTo($("#userbusiness"));
			
			$("#item"+jBusiness.businessId).data("business", jBusiness);
			//drop map markers
			var location = new Location(jBusiness.businessLat, jBusiness.businessLon);
			location.setLocationTye(trim(category.catDesc));
			var info = '<div class="phoneytext"><div class="name"><span id="index">'+ parseInt(i+1)+'. </span>' +jBusiness.businessName + '</div><div class="address">' +jBusiness.businessAddress +'</div></div>';
			location.setLocationInfo(info);
			location.setItemIndex(jBusiness.businessId);
			locationList.push(location);
			updateNavMenuList(jBusiness);
		});
		//place all markers
		setTimeout(function(){
			gmap.placeAllMarkers(locationList);
		}, 500);
		
		$(".listing_parent").live("click", function(){
			$(".item_selected").removeClass("item_selected");
			var clone = $(this).children().clone();
			$(this).addClass("item_selected");
			showDetails(clone, $(this).attr("rel"));
			gmap.showBubble($(this).attr("rel"));
		});
		$("#user-business-nav-list li:last").remove();//remove the last divider from dropdown business
		buildContextMenu();
	}
	
	function buildContextMenu() {
		$.contextMenu({
	        selector: '.context-menu', 
	        contextMenuCustomClass: 'dropdown-menu',
	        build: function($trigger, e) {
	            // this callback is executed every time the menu is to be shown
	            // its results are destroyed every time the menu is hidden
	            // e is the original contextmenu event, containing e.pageX and e.pageY (amongst other data)
	            return {
	                callback: function(key, options) {
	                    var m = "clicked: " + key;
	                    window.console && console.log(m) || alert(m); 
	                    console.log($(e.currentTarget).data("id"));
	                },
	                items: {
	                    "Delete": {
	                    	type:"html", 
	                    	notSelectable:false, 
	                    	name: "Delete", 
	                    	icon: "remove", 
	                    	childIcon:true, 
	                    	html: "<a><span class='fam-bin-empty'></span> Delete</a>"
	                    },
	                    "sep1": {type:"html", notSelectable:true, childIcon:true, html: "<div class='divider'></div>"},
	                    "Update": {type:"html", notSelectable:false,  name: "Update", icon: "edit", childIcon:true, html: "<a href='javascript:updateItem()'><span class='fam-page-edit'></span> Update</a>"},
	                    "sep2": {type:"html", notSelectable:true, childIcon:true, html: "<div class='divider'></div>"},
	                    "Add Details": {type:"html", notSelectable:false,  name: "AddDetail", icon: "details", childIcon:true, html: "<a><span class='fam-table-add'></span> Add Detail</a>"},
	                    "sep3": {type:"html", notSelectable:true,  childIcon:true, html: "<div class='divider'></div>"},
	                    "Update Details": {type:"html", notSelectable:false, name: "UpdateDetail", icon: "update", childIcon:true, html: "<a><span class='fam-table-edit'></span> Update Details</a>"},
	                    
	                }
	            };
	        }
	    });
	}
	
	function updateItem(itemId) {
		alert(itemId);
	}
	
	function updateNavMenuList(jBusiness) {
		$("#user-business-nav-list").append("<li class='dropdown-submenu' id='drown_"+jBusiness.id+"'>"+
												"<a tabindex='-1' href='#'><span class='fam-cog'></span> " + jBusiness.businessName + "</a>"+
												"<ul class='dropdown-menu' id='user-business-nav-list'>"+
													"<li><a><span class='fam-bin-empty'></span> Delete</a></li><li><div class='divider'></li>"+
													"<li><a><span class='fam-page-edit'></span> Update</a></li><li><div class='divider'></li>"+
													"<li><a><span class='fam-table-add'></span> Add Detail</a></li><li><div class='divider'></li>"+
													"<li><a><span class='fam-table-edit'></span> Update Details</a></li>"+
												"</ul>"+
											"</li>"+
											"<li><div class='divider'></li>");
	}
	
	function showDetails(clonedElement, id) {
		$("#details_container").data("buzId", id);
		//Need to re-do this code..... looks dump
		if($("#detailScroller").is(":visible") && $("#detailScroller").children().length > 0) {
			$("#detailScroller").children().children().hide();
			$("#detailScroller").children().html(clonedElement);
			$("#detailScroller").children().children().effect("slide", {direction: "right"}, 200);
		}
		else {
			$("#detailWrapper").show();
			if($("#detailScroller").children().length == 0) {
				$("#detailScroller").toggle("slide", {direction: "right"}, 100,function(){
					var details = $("<div class='details'>").append(clonedElement);
					$(this).html("");
					$(this).append(details);
					//$(this).css("display", "block");
				});
			}
			else {
				$("#detailScroller").children().children().hide();
				$("#detailScroller").children().html(clonedElement);
				$("#detailScroller").children().children().effect("slide", {direction: "right"}, 200, function(){
					$("#detailScroller").css("display", "block");
				});
			}
			
			
		}
		
		$("#details_container").css("height", $("#detailWrapper").height() - $("#detailNav").height() + "px");
		//
		setTimeout(function(){
			detailScroll = new iScroll("details_container");
			//detailScroll.refresh();
		}, 200);
	}
	function getOpenHour() {
		var monday = $("#monday_time").val();
		var tuesday = $("#tuesday_time").val();
		var wednesday = $("#wednesday_time").val();
		var thursday = $("#thursday_time").val();
		var friday = $("#friday_time").val();
		var saturday = $("#saturday_time").val();
		var sunday = $("#sunday_time").val();
		
		if(!$("#monday").is(":checked")) {
			monday = null;
		}
		if(!$("#tuesday").is(":checked")) {
			tuesday = null;
		}
		if(!$("#wednesday").is(":checked")) {
			wednesday = null;
		}
		if(!$("#thursday").is(":checked")) {
			thursday = null;
		}
		if(!$("#friday").is(":checked")) {
			friday = null;
		}
		if(!$("#saturday").is(":checked")) {
			saturday = null;
		}
		if(!$("#sunday").is(":checked")) {
			sunday = null;
		}
		
		var openHours = [monday, tuesday, wednesday, thursday, friday, saturday, sunday];
		return openHours;
	}
</script>
